#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 4 ]]; then
  echo "Usage: $0 input.mp3 start_seconds duration_seconds output.bin" >&2
  echo "Example: $0 song.mp3 15 8 assets/vreid_sample.bin" >&2
  exit 1
fi

SRC="$1"
START="$2"
DURATION="$3"
OUT="$4"

command -v ffmpeg >/dev/null || { echo "ffmpeg missing" >&2; exit 1; }
command -v python3 >/dev/null || { echo "python3 missing" >&2; exit 1; }

TMP_WAV=$(mktemp --suffix=.wav)
trap 'rm -f "$TMP_WAV"' EXIT

ffmpeg -loglevel error -y \
  -ss "$START" -t "$DURATION" \
  -i "$SRC" \
  -ac 1 -ar 6000 \
  -c:a pcm_u8 -sample_fmt u8 \
  "$TMP_WAV"

python3 - "$TMP_WAV" "$OUT" <<'PY'
import sys, wave, pathlib

wav_path, out_path = sys.argv[1:3]
with wave.open(wav_path, "rb") as wf:
    if wf.getnchannels() != 1 or wf.getsampwidth() != 1:
        raise SystemExit("Need mono 8-bit WAV input; ensure ffmpeg step succeeded")
    frames = wf.readframes(wf.getnframes())

# Pack 8-bit mono samples into 4-bit nibbles for SID volume playback.
packed = bytearray()
for i in range(0, len(frames), 2):
    hi = frames[i] >> 4
    lo = frames[i + 1] >> 4 if i + 1 < len(frames) else 0
    packed.append((hi << 4) | lo)

pathlib.Path(out_path).write_bytes(packed)
print(f"Wrote {len(packed)} bytes to {out_path}")
PY
